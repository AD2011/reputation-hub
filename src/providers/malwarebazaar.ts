import { BaseProvider } from './base';
import { ProviderResult } from '../types';

export class MalwareBazaarProvider extends BaseProvider {
  name = 'MalwareBazaar';
  supports = {
    ip: false,
    domain: false,
    hash: true,
    hashTypes: ['md5', 'sha1', 'sha256']
  };
  requiresKey = true;
  private baseUrl = 'https://mb-api.abuse.ch/api/v1';
  
  async checkHash(hash: string, hashType: string, apiKey: string): Promise<ProviderResult> {
    try {
      const formData = new FormData();
      formData.append('query', 'get_info');
      formData.append('hash', hash);
      
      const response = await fetch(`${this.baseUrl}/`, {
        method: 'POST',
        headers: { 'API-KEY': apiKey },
        body: formData
      });
      
      if (!response.ok) {
        return this.createErrorResult(`API error: ${response.status}`);
      }
      
      const data = await this.parseJSON(response);
      
      if (data.query_status === 'hash_not_found') {
        return {
          provider: this.name,
          status: 'success',
          reputation: 'clean',
          details: {
            message: 'Hash not found in MalwareBazaar database',
            queryStatus: data.query_status
          },
          url: `https://bazaar.abuse.ch/browse.php?search=${hash}`
        };
      }

      if (data.query_status !== 'ok') {
         return this.createErrorResult(`API query status: ${data.query_status}`);
      }
      
      // Found malware
      const sample = data.data && data.data[0];
      const tags = sample?.tags || [];
      const signature = sample?.signature || 'Unknown';
      const fileType = sample?.file_type || 'Unknown';
      
      return {
        provider: this.name,
        status: 'success',
        reputation: 'malicious',
        score: tags.length > 0 ? 100 : 80, // High confidence if tagged
        details: {
          fileType: fileType,
          signature: signature,
          tags: tags,
          firstSeen: sample?.first_seen,
          lastSeen: sample?.last_seen,
          intelligence: sample?.intelligence,
          vendorIntel: sample?.vendor_intel
        },
        url: `https://bazaar.abuse.ch/sample/${hash}/`
      };
    } catch (error) {
      return this.createErrorResult(error instanceof Error ? error.message : 'Unknown error');
    }
  }
}
